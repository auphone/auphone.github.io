<html><head><title>匯出龍族拼圖（Puzzle-Dragons）寵物清單的方法&nbsp;-&nbsp;auphone.net</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-92978795-2"></script><script data-ad-client="ca-pub-1447883820552850" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-92978795-2")</script><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><meta charset="UTF8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Sans+TC:400,700&display=swap.css"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 4.2.1"></head><body id="site"><div class="sidebar-wrap"><div class="sidebar"><div class="info"><a class="greetings" href="/"><h1>嗨,</h1><h2>我是Auphone</h2></a><div class="bio">揼Code尋生活<br>寫App為生存<br>學而時習之，不亦說乎？</div><div class="highlight">Happy Coding &lt;3</div><div class="social"><a href="https://github.com/auphone" target="_new"><i class="icon-github-circled"></i></a><a href="https://twitter.com/auphonehk" target="_new"><i class="icon-twitter-bird"></i></a></div></div><footer><div class="container"><a class="copy-right-text" href="/">ヾ(*ΦωΦ)ツ<br>© 2022 auphone.net</a><div id="sub"><form id="sub-form" action="https://auphone.us18.list-manage.com/subscribe/post?u=1b175b7b8039f63120af59b14&amp;id=f727c66d2f" method="post" target="_blank"><input id="sub-email" type="email" name="EMAIL" placeholder="電郵地址" required><button id="sub-btn" type="submit">訂閱</button></form></div></div></footer></div></div><div class="wrap"><div class="content"><link rel="stylesheet" href="/css/post.css"><div id="post"><article><p class="date">21年12月16日</p><h1 class="title">匯出龍族拼圖（Puzzle-Dragons）寵物清單的方法</h1><p></p><blockquote><p>最近又回鍋 PAD 了，從這遊戲開服以來，斷斷續續玩到現在已經有<strong>接近二千隻寵物了</strong>，每次回歸都要重新面對那個<strong>讓人頭痛的搜尋系統</strong>，這次終於下定決心想<strong>寫個程序來匯出我的寵物清單</strong>，好讓我更容易上手！</p></blockquote><img src="/posts/%E5%8C%AF%E5%87%BA%E9%BE%8D%E6%97%8F%E6%8B%BC%E5%9C%96%EF%BC%88Puzzle-Dragons%EF%BC%89%E5%AF%B5%E7%89%A9%E6%B8%85%E5%96%AE%E7%9A%84%E6%96%B9%E6%B3%95/website_demo.png"><p class="caption">我寫的一個手機版網頁 ヽ(=^･ω･^=)丿</p><h2 id="現有的-PAD-搜尋問題"><a href="#現有的-PAD-搜尋問題" class="headerlink" title="現有的 PAD 搜尋問題"></a>現有的 PAD 搜尋問題</h2><p>PAD 現在多了很多武裝和進化路線，每隻寵物<strong>隨便都有兩三張或以上的頭像</strong>，對我來說<strong>不太可能全部記得</strong>，有時候看 Youtube 抄隊伍我<strong>只是想知道有沒有那隻寵物都要來回搜尋好幾個網頁</strong>，皆因內建的搜尋工具<strong>不能用一個寵物編號搜尋牠們的進 / 退化寵物</strong>，雖然官方的 WEB 檢索某程度上能解決這問題，但還是讓我覺得很疲累</p><p class="splitter"><span>(´ ～`)</span></p><h2 id="Github-連結"><a href="#Github-連結" class="headerlink" title="Github 連結"></a>Github 連結</h2><p><strong>Tl;dr</strong> 我把原碼放在 <a href="https://github.com/auphone/pad-box-export-tool" target="_blank" rel="noopener">Github</a> 了，請慢用～</p><p><a href="https://github.com/auphone/pad-box-export-tool" target="_blank" rel="noopener">https://github.com/auphone/pad-box-export-tool</a></p><h2 id="OpenCV-Python-懶人組合"><a href="#OpenCV-Python-懶人組合" class="headerlink" title="OpenCV + Python 懶人組合"></a>OpenCV + Python 懶人組合</h2><p>繼<a href="/posts/一次成功用Open-CV拼圖的經驗">一次成功用 Open-CV 拼圖的經驗</a>，這次還是會用 OpenCV + Python 這個組合，我有<strong>試圖使用 Tensorflow 自行 train 一個 dataset</strong>，奈何不太在行而且<strong>每次 training 都要花好幾個小時…</strong> 最後還是決定用比較熟悉的方法</p><h4 id="以下是當前的版本"><a href="#以下是當前的版本" class="headerlink" title="以下是當前的版本"></a>以下是當前的版本</h4><ul><li>Opencv 4.5.4</li><li>Python 3.10.1</li><li>FFmpeg 4.4.1</li><li>ImageMagick 7.1.0</li></ul><h3 id="建立虛擬環境及安裝模組"><a href="#建立虛擬環境及安裝模組" class="headerlink" title="建立虛擬環境及安裝模組"></a>建立虛擬環境及安裝模組</h3><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs plain">python -m ensurepip --upgrade
python -m venv ~&#x2F;venv&#x2F;pad
source ~&#x2F;venv&#x2F;pad&#x2F;bin&#x2F;activate
pip install numpy matplotlib opencv-python</code></pre><p class="splitter"><span>=͟͟͞͞( •̀д•́)</span></p><h2 id="開始！"><a href="#開始！" class="headerlink" title="開始！"></a>開始！</h2><p>首先我們要像這樣<strong>用 screen recording 拍一條短片</strong>，重點是<strong>滾動的時候要用平均的速度</strong>方便之後處理</p><iframe src="https://player.vimeo.com/video/657345182" width="100%" height="100%" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe><p class="caption"><strong>沒錯！就是這個速度！(ゝ∀･)b</strong></p><h3 id="使用-FFmpeg-每秒截圖-10-次"><a href="#使用-FFmpeg-每秒截圖-10-次" class="headerlink" title="使用 FFmpeg 每秒截圖 10 次"></a>使用 FFmpeg 每秒截圖 10 次</h3><p>上面影片的<strong>速度大約是 1 秒 10 頁</strong>，按需要<strong>把 fps 改成其他數值</strong>，只要抽取出來的圖片<strong>能確實拍到所有寵物</strong>就 OK 了，把影片放到 <code>videos/box.mp4</code> 後運行</p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs bash">ffmpeg -i videos/box.mp4 -vf fps=10 ./out/screenshots/%d.jpg</code></pre><p class="caption"></p><h3 id="使用-ImageMagick-裁剪圖片"><a href="#使用-ImageMagick-裁剪圖片" class="headerlink" title="使用 ImageMagick 裁剪圖片"></a>使用 ImageMagick 裁剪圖片</h3><p>取得圖片之後我們立即<strong>把上下方多餘的部份移除</strong>，可以<strong>省掉之後一些運算的資源</strong>，同樣地這裡<strong>根據手機像素和比例自行更改數值</strong></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs bash">mogrify -crop 750x720+0+400 ./out/screenshots/\*.jpg</code></pre><p class="caption"></p><p>在 <code>./out/screenshots/</code> 會有很多長這樣的圖片 <img src="/posts/%E5%8C%AF%E5%87%BA%E9%BE%8D%E6%97%8F%E6%8B%BC%E5%9C%96%EF%BC%88Puzzle-Dragons%EF%BC%89%E5%AF%B5%E7%89%A9%E6%B8%85%E5%96%AE%E7%9A%84%E6%96%B9%E6%B3%95/pad_box_cropped.jpg"></p><p class="caption"><strong>圖片的像素不能太低喔！๑乛◡乛๑</strong></p><h2 id="抽取寵物圖示"><a href="#抽取寵物圖示" class="headerlink" title="抽取寵物圖示"></a>抽取寵物圖示</h2><p>因為這邊<strong>比較多數值需要修改</strong>，所以我們先<strong>抽樣測試一下</strong>，以下程序將會處理 <code>./out/screenshots/1.jpg</code>，這是我的 <strong>iphone SE2 的設定</strong>，完整代碼在下面</p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs bash">ICON_WIDTH = 120 // 圖示闊度
ICON_HEIGHT = 120 // 圖示高度
ICON_MARGIN_BOTTOM = 10 // 圖示底邊距，大約是顯示 Lv 的部份
ICON_SPACING = 17 // 圖示間距
PAGE_LEFT_PADDIG = 14 // 頁面左邊距，用於獲取第一張圖片 x 坐標
COL = 5 // 曼大橫行數量
ROW = 5 // 最大直行數量（會變動）</code></pre><p class="caption"></p><p>這邊用了 openCv 的 <strong><code>cv.findContours()</code> 及 <code>cv.boundingRect()</code> 取得大大小小的長方型</strong>，因為我們的<strong>頁面變化不多</strong>，所以這邊可以用一些<strong>固定數值</strong>找到在<strong>合理範圍內最大的長方型，</strong>從而計算出<strong>第一張和其他圖片的坐標</strong></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs python"><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> contours:
    rect = cv.boundingRect(c)
    <span class="hljs-keyword">if</span> cv.contourArea(c) &gt; <span class="hljs-number">10000</span>: <span class="hljs-keyword">continue</span>
    x,y,w,h = rect
    size = w * h
    <span class="hljs-keyword">if</span> size &gt; largestSize <span class="hljs-keyword">and</span> size &gt; <span class="hljs-number">5000</span> <span class="hljs-keyword">and</span> size &lt; <span class="hljs-number">15000</span>:
        largestSize = w * h
        coord = (x,y)</code></pre><p class="splitter"><span>d(^^*)</span></p><h4 id="1-畫出全部-boundingRect"><a href="#1-畫出全部-boundingRect" class="headerlink" title="1. 畫出全部 boundingRect"></a>1. 畫出全部 boundingRect</h4><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs python"><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> contours:
    rect = cv.boundingRect(c)
    ...</code></pre><p class="caption"></p><img src="/posts/%E5%8C%AF%E5%87%BA%E9%BE%8D%E6%97%8F%E6%8B%BC%E5%9C%96%EF%BC%88Puzzle-Dragons%EF%BC%89%E5%AF%B5%E7%89%A9%E6%B8%85%E5%96%AE%E7%9A%84%E6%96%B9%E6%B3%95/pad_rect_noise.png"><h4 id="2-加入條件縮小範圍"><a href="#2-加入條件縮小範圍" class="headerlink" title="2. 加入條件縮小範圍"></a>2. 加入條件縮小範圍</h4><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs python"><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> contours:
    ...
    <span class="hljs-keyword">if</span> size &gt; <span class="hljs-number">5000</span> <span class="hljs-keyword">and</span> size &lt; <span class="hljs-number">15000</span>:
        coord = (x,y)</code></pre><img src="/posts/%E5%8C%AF%E5%87%BA%E9%BE%8D%E6%97%8F%E6%8B%BC%E5%9C%96%EF%BC%88Puzzle-Dragons%EF%BC%89%E5%AF%B5%E7%89%A9%E6%B8%85%E5%96%AE%E7%9A%84%E6%96%B9%E6%B3%95/pad_rect_filtered.png"><p></p><h4 id="3-然後我們取最大面積的長方型"><a href="#3-然後我們取最大面積的長方型" class="headerlink" title="3. 然後我們取最大面積的長方型"></a>3. 然後我們取最大面積的長方型</h4><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs python"><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> contours:
    ...
    <span class="hljs-keyword">if</span> size &gt; largestSize:
        largestSize = w * h
        ...</code></pre><img src="/posts/%E5%8C%AF%E5%87%BA%E9%BE%8D%E6%97%8F%E6%8B%BC%E5%9C%96%EF%BC%88Puzzle-Dragons%EF%BC%89%E5%AF%B5%E7%89%A9%E6%B8%85%E5%96%AE%E7%9A%84%E6%96%B9%E6%B3%95/pad_rect_largest.png"><p></p><h4 id="4-計算出第一隻和其他寵物的位置"><a href="#4-計算出第一隻和其他寵物的位置" class="headerlink" title="4. 計算出第一隻和其他寵物的位置"></a>4. 計算出第一隻和其他寵物的位置</h4><p>詳見完整代碼</p><img src="/posts/%E5%8C%AF%E5%87%BA%E9%BE%8D%E6%97%8F%E6%8B%BC%E5%9C%96%EF%BC%88Puzzle-Dragons%EF%BC%89%E5%AF%B5%E7%89%A9%E6%B8%85%E5%96%AE%E7%9A%84%E6%96%B9%E6%B3%95/pad_rect_first.png"> <img src="/posts/%E5%8C%AF%E5%87%BA%E9%BE%8D%E6%97%8F%E6%8B%BC%E5%9C%96%EF%BC%88Puzzle-Dragons%EF%BC%89%E5%AF%B5%E7%89%A9%E6%B8%85%E5%96%AE%E7%9A%84%E6%96%B9%E6%B3%95/pad_opencv_rect.png"><h4 id="完整代碼連結"><a href="#完整代碼連結" class="headerlink" title="完整代碼連結"></a>完整代碼連結</h4><p><a href="https://github.com/auphone/pad-box-export-tool/blob/main/lib/extract_pet_verify.py" target="_blank" rel="noopener">Github連結: extract_pet_verify.py</a></p><p class="splitter"><span>(´◉‿◉｀)</span></p><h2 id="栽剪寵物圖示"><a href="#栽剪寵物圖示" class="headerlink" title="栽剪寵物圖示"></a>栽剪寵物圖示</h2><p><strong>取得坐標</strong>之後就很簡單了，我們會<strong>把圖示儲存到 <code>./out/cropped/</code></strong></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs python">...
crop_img = img[y1:y2, x1:x2]
cv.imwrite(<span class="hljs-string">'./out/cropped/'</span> + str(idx) + <span class="hljs-string">'.jpg'</span>, crop_img)
...</code></pre><img src="/posts/%E5%8C%AF%E5%87%BA%E9%BE%8D%E6%97%8F%E6%8B%BC%E5%9C%96%EF%BC%88Puzzle-Dragons%EF%BC%89%E5%AF%B5%E7%89%A9%E6%B8%85%E5%96%AE%E7%9A%84%E6%96%B9%E6%B3%95/pad_cropped_icons.png"><p class="caption"></p><h2 id="配對圖片"><a href="#配對圖片" class="headerlink" title="配對圖片"></a>配對圖片</h2><p>用自己的方法<strong>取得寵物圖示</strong>，我是從其他網頁偷來的所以就不多說了，自己去看 <code>./lib/image_downloader.js</code></p><h3 id="Feature-matching-SIFT-FLANN"><a href="#Feature-matching-SIFT-FLANN" class="headerlink" title="Feature matching - SIFT + FLANN"></a>Feature matching - SIFT + FLANN</h3><p>我們用 nest loop 把全部圖片 1:1 比對，使用了 OpenCV 的 feature matching 功能，這邊就不多說了，90% 代碼都是<a href="https://docs.opencv.org/4.5.4/d5/d6f/tutorial_feature_flann_matcher.html" target="_blank" rel="noopener">直接複製這裡</a>的</p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs python">...
sift = cv.SIFT_create()
matcher = cv.DescriptorMatcher_create(cv.DescriptorMatcher_FLANNBASED)

kp, des = sift.detectAndCompute(src,<span class="hljs-literal">None</span>)
kp2, des2 = sift.detectAndCompute(cropped,<span class="hljs-literal">None</span>)

matches = matcher.knnMatch(des1,des2,k=<span class="hljs-number">2</span>)

score = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> m,n <span class="hljs-keyword">in</span> matches:
    <span class="hljs-keyword">if</span> m.distance &lt; <span class="hljs-number">0.75</span>*n.distance:
        score += <span class="hljs-number">1</span>

<span class="hljs-keyword">if</span> score &gt; <span class="hljs-number">15</span> <span class="hljs-keyword">and</span> score &gt; maxscore:
    maxscore = score
    maxid = id
...</code></pre><p>&nbsp;</p><h4 id="確認一下比對結果"><a href="#確認一下比對結果" class="headerlink" title="確認一下比對結果"></a>確認一下比對結果</h4><p>如果在 <a href="https://github.com/auphone/pad-box-export-tool/blob/main/lib/match.py" target="_blank" rel="noopener">match.py</a> <strong>打開 <code>DEBUG</code> 模式</strong>，就可以<strong>生成這些圖片</strong>讓我們可以肉眼比對再<strong>進行微調以提升準確率</strong>，暫時就我略略的觀察<strong>準確率已高達 90%</strong>，對我來說已經非常足夠了～</p><img src="/posts/%E5%8C%AF%E5%87%BA%E9%BE%8D%E6%97%8F%E6%8B%BC%E5%9C%96%EF%BC%88Puzzle-Dragons%EF%BC%89%E5%AF%B5%E7%89%A9%E6%B8%85%E5%96%AE%E7%9A%84%E6%96%B9%E6%B3%95/pad_opencv_match_result.jpg"><h2 id="生成寵物編號"><a href="#生成寵物編號" class="headerlink" title="生成寵物編號"></a>生成寵物編號</h2><p>最後我們可以在 <code>./out/ids.txt</code> 取得影片中<strong>寵物編號的 CSV</strong></p><blockquote><p>388,559,636,644,650,778…</p></blockquote><p class="caption"></p><h4 id="項目連結"><a href="#項目連結" class="headerlink" title="項目連結"></a>項目連結</h4><p><a href="https://github.com/auphone/pad-box-export-tool" target="_blank" rel="noopener">https://github.com/auphone/pad-box-export-tool</a></p><p class="splitter"><span>(●__●)</span></p><h2 id="相關文章"><a href="#相關文章" class="headerlink" title="相關文章"></a>相關文章</h2><ul><li><a href="/posts/一次成功用Open-CV拼圖的經驗">一次成功用 Open CV 拼圖的經驗</a></li><li><a href="/posts/OpenCV拼圖輔助程式（續）">OpenCV 拼圖輔助程式（續）</a></li></ul><p></p></article></div><button id="btnScrollTop" onclick="scrollToTop()"><i class="icon-up-big"></i></button></div></div><script src="/js/app.js"></script></body></html>