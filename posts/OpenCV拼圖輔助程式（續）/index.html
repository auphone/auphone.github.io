<html><head><title>OpenCV拼圖輔助程式（續）&nbsp;-&nbsp;auphone.net</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-92978795-2"></script><script data-ad-client="ca-pub-1447883820552850" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-92978795-2")</script><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><meta charset="UTF8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Sans+TC:400,700&display=swap.css"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 4.2.1"></head><body id="site"><div class="sidebar-wrap"><div class="sidebar"><div class="info"><a class="greetings" href="/"><h1>嗨,</h1><h2>我是Auphone</h2></a><div class="bio">揼Code尋生活<br>寫App為生存<br>學而時習之，不亦說乎？</div><div class="highlight">Happy Coding &lt;3</div><div class="social"><a href="https://github.com/auphone" target="_new"><i class="icon-github-circled"></i></a><a href="https://twitter.com/auphonehk" target="_new"><i class="icon-twitter-bird"></i></a></div></div><footer><div class="container"><a class="copy-right-text" href="/">ヾ(*ΦωΦ)ツ<br>© 2022 auphone.net</a><div id="sub"><form id="sub-form" action="https://auphone.us18.list-manage.com/subscribe/post?u=1b175b7b8039f63120af59b14&amp;id=f727c66d2f" method="post" target="_blank"><input id="sub-email" type="email" name="EMAIL" placeholder="電郵地址" required><button id="sub-btn" type="submit">訂閱</button></form></div></div></footer></div></div><div class="wrap"><div class="content"><link rel="stylesheet" href="/css/post.css"><div id="post"><article><p class="date">19年02月20日</p><h1 class="title">OpenCV拼圖輔助程式（續）</h1><p></p><p>這是<a href="/posts/一次成功用Open-CV拼圖的經驗">一次成功用 Open-CV 拼圖的經驗</a>的續篇，主要是想補充並紀錄一下之前沒提到的一些研究結果</p><h2 id="OpenCV-Python"><a href="#OpenCV-Python" class="headerlink" title="OpenCV + Python"></a>OpenCV + Python</h2><p>就如之前提到，我用的是 OpenCV 和 Python 這個組合，因為 OpenCV <strong>3.0 支援的語言不多</strong>，所以我選了最容易上手的 Python，最近發現 OpenCV 4.0 開始支援 Node.js 了，可惡！</p><h2 id="黑蘋果-hackintosh"><a href="#黑蘋果-hackintosh" class="headerlink" title="黑蘋果 hackintosh"></a>黑蘋果 hackintosh</h2><p>系統方面，我的首選是 Linux，不考慮 Windows。但因為這次要用到<strong>大量 GPU</strong>，Linux 的<strong>支援比較弱</strong>，就決定用早就想試試的 hackintosh，還可以 build iOS 呢﹗</p><img src="/posts/OpenCV%E6%8B%BC%E5%9C%96%E8%BC%94%E5%8A%A9%E7%A8%8B%E5%BC%8F%EF%BC%88%E7%BA%8C%EF%BC%89/hackintosh.jpg" title="Hackintosh"><p>不過要安裝黑蘋果，<del>首先要有蘋果電腦</del>，詳情自己 Google 一下，不難找的</p><div class="splitter"><span>(´-ω-｀)</span></div><h2 id="建立-Python-虛構環境"><a href="#建立-Python-虛構環境" class="headerlink" title="建立 Python 虛構環境"></a>建立 Python 虛構環境</h2><p>裝好 Python 後先建立 python 的<strong>虛構環境</strong>，原理就像 NodeJS 的 node_modules，<strong>避免這項目的模組影響到其他項目</strong>。我的選擇是使用 <strong>virtualenv</strong>，沒甚麼原因只是第一個搜尋到就是這個，另一個<strong>替代方案是用 Conda</strong></p><p></p><p class="code-caption" data-lang="sh" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs sh"><span class="hljs-comment"># 安裝 virtualenv</span>
$ pip install virtualenv

<span class="hljs-comment"># 在項目內建立虛構環境</span>
$ <span class="hljs-built_in">cd</span> ~/my-project
$ virtualenv jigsaw-env

<span class="hljs-comment"># 啟用虛構環境</span>
$ <span class="hljs-built_in">source</span> jigsaw-env/bin/activate

<span class="hljs-comment"># 最檢查pip路徑是否正確</span>
$ pip -V</code></pre><p></p><p>如果沒出錯會看到 pip 指向剛設定好的路徑</p><p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs bash">pip 19.0.3 from ../jigsaw-env/lib/python3.7/site-packages/pip (python 3.7)</code></pre><p></p><p>使用這個指令離開虛擬環境</p><p></p><p class="code-caption" data-lang="sh" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs sh">$ deactivate</code></pre><p></p><h2 id="安裝-OpenCV"><a href="#安裝-OpenCV" class="headerlink" title="安裝 OpenCV"></a>安裝 OpenCV</h2><p>3.0 跟 4.0 的安裝方法沒太大差別，兩者都需要<strong>連同 <a href="https://github.com/opencv/opencv_contrib" target="_blank" rel="noopener">OpenCV extra modules</a> 安裝</strong>，比較麻煩的是當中要用到的 SIFT 不是免費技術，所以在 compile 的時候需要同意一些條款，簡單來說就是<strong>不能用 pre-built 版本</strong>，只能自己 build 了…</p><p>以下是 OpenCV 4 的安裝流程，當中 Python 的設定請<strong>自行更改路徑</strong>，參考這篇 <a href="https://docs.opencv.org/trunk/d7/d9f/tutorial_linux_install.html" target="_blank" rel="noopener">OpenCV: Installation in Linux</a></p><p></p><p class="code-caption" data-lang="sh" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs sh"><span class="hljs-comment"># 先 clone 這兩個項目</span>
$ git <span class="hljs-built_in">clone</span> https://github.com/opencv/opencv.git
$ git <span class="hljs-built_in">clone</span> https://github.com/opencv/opencv_contrib.git

<span class="hljs-comment"># 建立 Build 資料夾</span>
$ <span class="hljs-built_in">cd</span> opencv
$ mkdir build
$ <span class="hljs-built_in">cd</span> build

<span class="hljs-comment"># build 需要自行更改 python 路徑</span>
$ cmake -DOPENCV_ENABLE_NONFREE:BOOL=ON \
  -DOPENCV_EXTRA_MODULES_PATH=../../opencv_contrib/modules \
  -DPYTHON3_EXECUTABLE=/usr/bin/python3 \
  -DPYTHON_INCLUDE_DIR=/usr/include/python3.7m \
  -DPYTHON_LIBRARY=/usr/lib64/libpython3.7m.so \
  -DPYTHON3_NUMPY_INCLUDE_DIRS=/usr/lib/python3.7/site-packages/numpy/core/include/ \
  ..</code></pre><p></p><p>如果 Python 的設定正確，應該會看到類似這樣的字串，如果你沒看見<code>Python 3</code>，一定是<strong>有東西忘記輸入或輸入錯了</strong></p><p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs bash">--   Python 3:
--     Interpreter:                 /usr/bin/python3 (ver 3.7.2)
--     Libraries:                   /lib64/libpython3.7m.so (ver 3.7.2)
--     numpy:                       /usr/lib/python3.7/site-packages/numpy/core/include/ (ver )
--     install path:                lib/python3.7/site-packages/cv2/python-3.7
--
--   Python (<span class="hljs-keyword">for</span> build):            /usr/bin/python2</code></pre><p></p><p>最後用 <code>make</code> compile 和安裝</p><p></p><p class="code-caption" data-lang="sh" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs sh">$ make -j7

$ sudo make install</code></pre><p></p><p>如果出現了這句</p><p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs bash">ModuleNotFoundError: No module named <span class="hljs-string">'cv2'</span></code></pre><p></p><p>就需要在<code>~/.bashrc</code>或<code>~/.zshrc</code>的最後一行加上這句，<strong>讓 Python 能讀取<code>site-packages</code>這個資料夾</strong></p><p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><pre><code class="hljs bash"><span class="hljs-built_in">export</span> PYTHONPATH=/usr/<span class="hljs-built_in">local</span>/lib/python3.7/site-packages:<span class="hljs-variable">$PYTHONPATH</span></code></pre><p></p><p>整個過程我的 Xeon 處理器大概用了 10 分鐘，如果是 i5 或以下的<strong>有機會超過半小時</strong>，喝杯咖啡再回來吧</p><div class="splitter"><span>(´・ω・)つ旦</span></div><h2 id="技術應用"><a href="#技術應用" class="headerlink" title="技術應用"></a>技術應用</h2><p>這個項目我總共寫了</p><ul><li>一個 Python 伺服器</li><li>一個用 React Native 寫的 iOS App</li></ul><img src="/posts/OpenCV%E6%8B%BC%E5%9C%96%E8%BC%94%E5%8A%A9%E7%A8%8B%E5%BC%8F%EF%BC%88%E7%BA%8C%EF%BC%89/react_native.png" title="React Native"><p>伺服器主要是 App 跟 OpenCV 的溝通，渠道是 socket.io，iOS App 的作用是拍照然後<strong>透過 socket.io 把圖片傳送到伺服器</strong>，沒甚麼特別我就不多講了，而且已經是 iOS 10 時候的事了，所以現在有 87% 機率是不能運行的了</p><h3 id="OpenCV-圖像比對技術"><a href="#OpenCV-圖像比對技術" class="headerlink" title="OpenCV 圖像比對技術"></a>OpenCV 圖像比對技術</h3><p>除此之外就是圖像比對的技術，也就是<strong>這個項目的核心</strong>，俗語有講「貨比三家不吃虧」所以我幾乎把 OpenCV 內建的比對功能都試了一遍</p><h3 id="Feature-Matching-比較圖片特徵"><a href="#Feature-Matching-比較圖片特徵" class="headerlink" title="Feature Matching 比較圖片特徵"></a>Feature Matching 比較圖片特徵</h3><p>Feature Matching (以下簡稱 FM) 是 OpenCV 的功能，<a href="https://docs.opencv.org/3.4.3/df/d54/tutorial_py_features_meaning.html" target="_blank" rel="noopener">Feature</a> 即特徵，FM 即是找出<strong>兩件物件的相似特徵</strong></p><img src="/posts/OpenCV%E6%8B%BC%E5%9C%96%E8%BC%94%E5%8A%A9%E7%A8%8B%E5%BC%8F%EF%BC%88%E7%BA%8C%EF%BC%89/opencv.jpg" title="OpenCv Feature Matching"><p>如果是原圖與原圖的比較，我們可以用 Template Matching (TM)，但要從拍照取得的 3D 拼圖塊跟 2D 的原圖比較，TM 就沒辦法處理了，因為<strong>拍下來的圖片</strong>一定是<strong>變形的</strong></p><p>OpenCV 有幾種 Feature Matching 算法可以使用，以下就是我測試過的</p><h3 id="SIFT-Brute-Force-Matching"><a href="#SIFT-Brute-Force-Matching" class="headerlink" title="SIFT Brute-Force Matching"></a>SIFT Brute-Force Matching</h3><p>Scale-invariant feature transform 是一個很<strong>常用的算法</strong>，初步測試讓我很驚訝，因為真的<strong>慢到一個點</strong>，單使用這個算法是不可能的了，混合其它算法出來的結果還可以</p><img src="/posts/OpenCV%E6%8B%BC%E5%9C%96%E8%BC%94%E5%8A%A9%E7%A8%8B%E5%BC%8F%EF%BC%88%E7%BA%8C%EF%BC%89/sift.jpg" title="SIFT Algorithm"><p>運算時間︰9 秒</p><p>p.s. 這速度光是運算 1000 張圖片就要花 <strong>2.5 小時</strong>了…</p><h3 id="ORB-Brute-Force-Matching"><a href="#ORB-Brute-Force-Matching" class="headerlink" title="ORB Brute-Force Matching"></a>ORB Brute-Force Matching</h3><p>Oriented FAST and Rotated BRIEF 是一個 SIFT 的替代方案，這個運算方法的優點是<strong>快和省電腦資源</strong>，重點是<strong>免費</strong>，可惜效果不是很理想，最後沒採用</p><img src="/posts/OpenCV%E6%8B%BC%E5%9C%96%E8%BC%94%E5%8A%A9%E7%A8%8B%E5%BC%8F%EF%BC%88%E7%BA%8C%EF%BC%89/orb.jpg" title="ORB Algorithm"><p>運算時間︰1 秒</p><p>p.s. 真的很快</p><h3 id="FLANN-based-Matcher"><a href="#FLANN-based-Matcher" class="headerlink" title="FLANN based Matcher"></a>FLANN based Matcher</h3><p>為了<strong>解決速度問題</strong>，我們會使用 FLANN (Fast Library for Approximate Nearest Neighbors)配搭 SIFT 使用，看到名字有個 Fast 字就知道是根速度問題有關了</p><img src="/posts/OpenCV%E6%8B%BC%E5%9C%96%E8%BC%94%E5%8A%A9%E7%A8%8B%E5%BC%8F%EF%BC%88%E7%BA%8C%EF%BC%89/flann.jpg" title="FLANN Matcher"><p>運算時間︰5 秒</p><h3 id="Homography"><a href="#Homography" class="headerlink" title="Homography"></a>Homography</h3><p>calib3d 的 Homography 是<strong>這次的主角</strong>，它可以<strong>修正圖片因拍攝而變形的問題</strong>，讓它比較接近原圖，當然拍攝的圖片也不能變形得太誇張</p><img src="/posts/OpenCV%E6%8B%BC%E5%9C%96%E8%BC%94%E5%8A%A9%E7%A8%8B%E5%BC%8F%EF%BC%88%E7%BA%8C%EF%BC%89/homography.jpg" title="Homography"><p>運算時間︰5 秒</p><div class="splitter"><span>Σ(ﾟωﾟ)</span></div><h2 id="運算速度太慢"><a href="#運算速度太慢" class="headerlink" title="運算速度太慢"></a>運算速度太慢</h2><p>這個項目遇到<strong>不少問題</strong>，雖然<strong>大部份都可以無視</strong>，反正我的目的就只是完成這副拼圖，但是<strong>速度的問題是一定要解決</strong>的，我把解決方法歸納於這兩點</p><h3 id="選擇-macOS"><a href="#選擇-macOS" class="headerlink" title="選擇 macOS"></a>選擇 macOS</h3><p>第一個關鍵因素是系統，嘗試過三個主流系統後，發現 <strong>Linux 的圖像處理明顯比其他兩個慢</strong>，我不想花時間在效能提升方面上，所就直接轉用 hackintosh 了</p><p>p.s. 我的顯示卡是 GTX 960，因為慢得很誇張所以比較各系統時有很明顯的感覺</p><h3 id="壓縮圖片大小到合理範圍"><a href="#壓縮圖片大小到合理範圍" class="headerlink" title="壓縮圖片大小到合理範圍"></a>壓縮圖片大小到合理範圍</h3><p>另一個因素是圖片大小，這裡指的圖片指的是<strong>拼圖原圖和手機拍的圖片</strong>，把原圖<strong>切割成多個部份可以運用多線程提升速度</strong>，我在這個項目就把它切成 9 等份</p><img src="/posts/OpenCV%E6%8B%BC%E5%9C%96%E8%BC%94%E5%8A%A9%E7%A8%8B%E5%BC%8F%EF%BC%88%E7%BA%8C%EF%BC%89/open_cv_program.jpeg" title="OpenCV Program in 9 screen"><p>手機拍攝的圖片像素就縮減至 1000px，但<strong>不能太小因為會不準確</strong>，這個過程我在 Python 處理，不知道用 iOS 壓縮後再傳送會不會比較快，對於我的 6S 來說大概是不會吧，而且用 subnet 傳送一張圖片應該是以微秒作單位的</p><h2 id="花了很多時間-build-iOS"><a href="#花了很多時間-build-iOS" class="headerlink" title="花了很多時間 build iOS"></a>花了很多時間 build iOS</h2><p>沒有太多 App 開發經驗，所以跟 OpenCV 比起來反而花了更多時間在 build iOS 那邊，除了要解決一堆權限問題之外，本來以為使用 Reactive Native 就不需要用 Xcode，最後發現是自己一廂情願…</p><h2 id="準確率不太好"><a href="#準確率不太好" class="headerlink" title="準確率不太好"></a>準確率不太好</h2><p>準確率嗯… 大概 50%吧，重新拍一次也只能提高至大約 70%，所以說有 30%還是要靠自己了，問題是我覺得這拼圖<strong>每一塊的獨特性</strong>已經很高了，這樣才只有 70%，很難想像能應用在其他比拼圖上…</p><p>p.s. 而且這程式其實也沒幫到多少，因為就算程式認到了我還要在拼圖板上<strong>猜那塊拼圖的位置</strong> Orz，下次還是先列印 1:1 的原圖作為<strong>拼圖的底板</strong>好了</p><h2 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h2><p>後悔莫及</p><div class="splitter"><span>( ´•̥̥̥ω•̥̥̥` )</span></div><h2 id="相關文章"><a href="#相關文章" class="headerlink" title="相關文章"></a>相關文章</h2><ul><li><a href="/posts/一次成功用Open-CV拼圖的經驗">一次成功用 Open CV 拼圖的經驗</a></li><li><a href="/posts/匯出龍族拼圖（Puzzle-Dragons）寵物清單的方法">匯出龍族拼圖（Puzzle-Dragons）寵物清單的方法</a></li></ul><p></p></article></div><button id="btnScrollTop" onclick="scrollToTop()"><i class="icon-up-big"></i></button></div></div><script src="/js/app.js"></script></body></html>